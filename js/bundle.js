(function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.i=function(d){return d},b.d=function(d,e,f){b.o(d,e)||Object.defineProperty(d,e,{configurable:!1,enumerable:!0,get:f})},b.n=function(d){var e=d&&d.__esModule?function(){return d['default']}:function(){return d};return b.d(e,'a',e),e},b.o=function(d,e){return Object.prototype.hasOwnProperty.call(d,e)},b.p='',b(b.s=2)})([function(a){function c(C,D,E,F,G,H,I){C.beginPath(),C.moveTo(D,E),C.lineTo(F,G),C.lineWidth=H,C.strokeStyle=I,C.stroke(),C.closePath()}function d(C,D,E,F,G){C.beginPath(),C.arc(D,E,F,0,2*Math.PI,!1),C.fillStyle=G,C.fill(),C.closePath()}function e(C,D,E,F,G,H){C.fillStyle=H,C.fillRect(D,E,F-D,G-E)}function f(C,D){if(C.sofuran&&0<C.sofuran.length){let E=0,F=0;for(let G=0;G<C.sofuran.length;G++){let H=C.sofuran[G],I=C.sofuran[G+1];if(I){if(D<I.time)return E+=H.bpm/60*(D-F),E;let J=I.time-H.time;E+=H.bpm/60*J,F+=J}else return E+=H.bpm/60*(D-F),E}}else return C.baseBpm/60*D}function g(C,D){return Math.round(48*f(C,D))/48}function h(C,D){let E=D.start,F=C[C.length-1].sec,H=g(D,F-E),I=2*t+o,J=2*t+H*m,L=J-t,M=t,O=document.createElement('canvas');O.width=I,O.height=J;let P=O.getContext('2d');P.imageSmoothingEnabled=!0;let Q=[null,!1,!1,!1,!1,!1],R={};for(let T of C){let U=T.type,V=T.sec,W=T.finishPos,X=T.status,Y=T.groupId,Z=V-E;if(D.mirror&&(W=[0,5,4,3,2,1][W]),1===U||2===U){let _=Q[W],aa=g(D,Z);if(2===U&&!1===_)Q[W]=aa;else if(1===U&&!1!==_||2===U){let ca=M+n*(W-0.5);e(P,ca-v/2,L-_*m,ca+v/2,L-aa*m,A[D.style]),Q[W]=!1}}if(0!==Y){let _=R[Y],aa=g(D,Z);if(_&&4>aa-_[1]){let ba=M+n*(_[0]-1)+n/2,ca=M+n*(W-1)+n/2,da=L-_[1]*m;c(P,ba,da,ca,L-aa*m,w,A[D.style])}R[Y]=[W,aa]}}for(let T of C){let U=T.type,V=T.sec,W=T.finishPos,X=T.status;if(D.mirror&&(W=[0,5,4,3,2,1][W],X=[0,2,1][X]),1===U||2===U){let Z=g(D,V-E),_=M+n*(W-0.5),aa=L-Z*m;if(d(P,_,aa,u,z[D.style]),2===U&&(d(P,_,aa,u-3,'#ffffff'),d(P,_,aa,u-3.5,z[D.style])),0!==X){P.beginPath();var S=1===X?-1:1;P.moveTo(_-5*S,aa-1),P.lineTo(_-5*S,aa+1),P.lineTo(_,aa+1),P.lineTo(_,aa+4),P.lineTo(_+5*S,aa),P.lineTo(_,aa-4),P.lineTo(_,aa-1),P.fillStyle='#ffffff',P.fill(),P.closePath()}}}0===D.sofuran.length&&D.sofuran.push({time:0,bpm:D.baseBpm});for(let T=0;T<D.sofuran.length;T++){let V=I-t,W=g(D,D.sofuran[T].time),X=L-W*m-0.5;c(P,M,X,V,X,1,B.bpm),P.font='bold 14px',P.fillStyle=B.bpm,P.fillText(D.sofuran[T].bpm,V+2,X+4)}return O}function j(C,D){let E=C.width-2*t,F=C.height-2*t,G=[],H=1,I=0,J=I;for(0!==D.upbeat&&(H=2,I=D.upbeat);J*m<F;){let P=4;D.measure[H]&&(P=D.measure[H]);let Q=D.beatsPerColumn;D.column[G.length+1]&&(Q=D.column[G.length+1]),Q<I+P&&(G.push(I),I=0),J+=P,I+=P,H+=1}0!==I&&G.push(I);let K=2*t+q*G.length,L=2*t+D.beatsPerColumn*m+s,M=document.createElement('canvas');M.width=K,M.height=L;let N=M.getContext('2d');N.imageSmoothingEnabled=!0,e(N,0,0,K,L,'#ffffff'),H=1,I=0,J=0;let O=4;for(let P=0;P<G.length;P++){let Q=t+P*q+p,R=Q+o,S=L-t,T=S-G[P]*m;0!==P&&(S-=D.upbeat*m,T-=D.upbeat*m),c(N,Q,T,Q,S,1,B[1]),c(N,R,T,R,S,1,B[1]),1==H&&0!==D.upbeat&&(O=D.upbeat);for(let fa,ea=0;ea<2*G[P];ea++){fa=B[3],0==ea%2&&(fa=B[2]);let ga=S-m*ea/2;if(I===O){fa=B[1],N.font='bold 14px';let ha=N.measureText(H);N.fillStyle='#000000',N.fillText(H,Q-ha.width-4,ga+O*m),H+=1,I=0,O=D.measure[H]?D.measure[H]:4}c(N,Q,ga,R,ga,1,fa),I+=0.5}N.font='bold 14px';let U=N.measureText(H);N.fillStyle='#000000',N.fillText(H,Q-U.width-4,T+O*m),c(N,Q,T,R,T,1,B[1]),c(N,Q,S,R,S,1,B[1]);let W=C.width,X=m*G[P],Y=C.height-t-m*J-X,_=T;Y-=t,X+=2*t,_-=t,N.drawImage(C,0,Y,W,X,Q-t,_,W,X);let aa=o+2*p,ba=t,ca=N.createLinearGradient(0,_,0,_+ba);ca.addColorStop(0,'#ffffff'),ca.addColorStop(0.4,'#ffffff'),ca.addColorStop(1,'rgba(255, 255, 255, 0)');let da=N.createLinearGradient(0,S,0,S+ba);da.addColorStop(0,'rgba(255, 255, 255, 0)'),da.addColorStop(0.6,'#ffffff'),da.addColorStop(1,'#ffffff'),N.fillStyle=ca,N.fillRect(Q-p,_,aa,ba),N.fillStyle=da,N.fillRect(Q-p,S,aa,ba),J+=G[P]}return M}function k(C,D={}){let E={start:0,sofuran:[],baseBpm:120,upbeat:0,measure:{},beatsPerColumn:16,column:{},info:{},style:'black',mirror:!1};for(let G=0;G<C.length;G++)if(100===C[G].type&&(E.info.maxCombo=C[G].status),''!==C[G].sec&&0!==C[G].sec){E.start=C[G].sec;break}let F=Object.assign(E,D);return F}const m=48,n=22,o=5*n,p=20,q=o+2*p,s=50,t=30,u=6,v=12,w=8,z={pink:'#ef3294',blue:'#2496f8',orange:'#f78200',black:'#000000'},A={pink:'#f093b2',blue:'#73def7',orange:'#fcc64a',black:'#aaaaaa'},B={1:'#000000',2:'#aaaaaa',3:'#dddddd',bpm:'#ff0000'};a.exports=function(C,D){let E=k(C,D),F=h(C,E),G=j(F,E);return G}},function(a){a.exports.$=document.querySelector.bind(document),a.exports.$$=document.querySelectorAll.bind(document),a.exports.readFileAsString=(c)=>{return new Promise((d)=>{let f=new FileReader;f.onload=(g)=>{let h=g.target.result;d(h)},f.readAsText(c)})},a.exports.readFileAsArrayBuffer=(c,d='utf-8')=>{return new Promise((e)=>{let g=new FileReader;g.onload=(h)=>{let j=h.target.result,k=new Uint8Array(j),l=new TextDecoder(d),m=l.decode(k);e(m)},g.readAsArrayBuffer(c)})}},function(a,b,c){function d(o){k(o).then((p)=>{let q=JSON.parse(p);window._cacheStageJson=p;for(let u=0;u<q.length;u++)if(''!==q[u].sec&&0!==q[u].sec){j('#options-start').value=q[u].sec;break}let s=l(q,{}),t=j('.pane-left canvas');t?e(t,s):(j('.pane-left').innerHTML='',j('.pane-left').appendChild(s))})}function e(o,p){let q=o.getContext('2d');q.clearRect(0,0,o.width,o.height),o.width=p.width,o.height=p.height,q.drawImage(p,0,0,p.width,p.height,0,0,p.width,p.height)}function f(o,p,q){let s=j(o).value;s=s.split('\n').filter((t)=>!t.startsWith(';')).map((t)=>t.trim());for(let t of s){let u=t.match(p);u&&q(u)}}const h=c(1),{$:j,readFileAsString:k}=h,l=c(0),m=j('.panel-drop');m.addEventListener('dragover',(o)=>{o.stopPropagation(),o.preventDefault(),o.dataTransfer.dropEffect='copy'}),m.addEventListener('drop',(o)=>{o.stopPropagation(),o.preventDefault();let p=o.dataTransfer.files[0];d(p)});const n=j('.btn-update');n.addEventListener('click',function(){if(!window._cacheStageJson)return;let o=JSON.parse(window._cacheStageJson),p={start:parseFloat(j('#options-start').value),sofuran:[],baseBpm:parseFloat(j('#options-baseBpm').value),upbeat:parseFloat(j('#options-upbeat').value),measure:{},beatsPerColumn:parseInt(j('#options-beatsPerColumn').value),column:{},info:{},style:j('#options-style').value,mirror:j('#options-mirror').checked};f('#options-sofuran',/(\d+|\d+\.\d+)\s*::\s*(\d+|\d+\.\d+)/,(t)=>{p.sofuran.push({time:parseFloat(t[1]),bpm:parseFloat(t[2])})}),f('#options-measure',/(\d+)\s*::\s*(\d+|\d+\.\d+)/,(t)=>{p.measure[t[1]]=parseFloat(t[2])}),f('#options-column',/(\d+)\s*::\s*(\d+)/,(t)=>{p.column[t[1]]=parseFloat(t[2])});let q=l(o,p),s=j('.pane-left canvas');e(s,q)})}]);